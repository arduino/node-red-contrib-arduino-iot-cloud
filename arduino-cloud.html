<script type="text/javascript">
  window.connectionManager = [];

  function validator(v) {
    return (v !== null && v !== "" && v !== undefined);
  }

  function getDefaults(nodeName){
    var ret={connection: { type: "arduino-connection", validate: validator },
        thing: { value: "", validate: validator },
        property: { value: "", validate: validator },
        name: { value: "", validate: validator },
        propname: { value: "" },
        prevconnection: { value: "" }
      };

    if (nodeName === "property in hist" || nodeName === "property in poll"){
      ret['timeWindowCount'] = { value: 1, validate: RED.validators.number(), required: true };
      ret['timeWindowUnit'] = { value: '3600', required: true };
    }
    return ret;
  }

  function getName(nodeName){
    var ret;
    switch (nodeName){
      case 'property in':
      case 'property out':
        ret='property';
        break;
      case 'property in hist':
        ret='historic';
        break;
      case 'property in poll':
        ret ='periodic';
        break;
      case 'property in push':
        ret = 'inject';
        break;

    }
    return ret;
  }

  function setupNode(nodeName, ins, outs) {
    var defaults = getDefaults(nodeName);
    var name = getName(nodeName);
    RED.nodes.registerType(nodeName, {
      category: 'Arduino IoT Cloud',
      color: '#00979d',
      defaults: defaults,
      inputs: ins,
      outputs: outs,
      icon: "arduino.png",
      label: function () {
        return this.name || name;
      },
      paletteLabel: name,
      oneditprepare: function () {
        if (this.connection && this.connection !== "_ADD_") {
          initThings(this.connection, this.thing);
          initProperties(this.connection, this.thing, this.property, outs);
        }
        $("select#node-input-connection").change(() => {
          const connection = $("#node-input-connection").val();
          const connectionTmp = window.connectionManager[connection];
          const isUpdatedConnection = connectionTmp ? connectionTmp.isUpdatedConnection : false;
          if (connection == this.prevconnection && isUpdatedConnection === false) return;
          if (connectionTmp)
            connectionTmp.isUpdatedConnection = false;
          this.prevconnection = connection;
          this.connection = connection;
          $("select#node-input-thing").empty();
          $("select#node-input-property").empty();
          $("#node-input-name").val("");
          this.thing = "";
          this.property = "";
          this.propname = "";
          this.name = "";
          if (connection !== "_ADD_") {
            initThings(this.connection, this.thing);
          }
          $("#node-input-thing").trigger("change");
        });
        $("#node-input-thing").change(() => {

          const thing_id = $("#node-input-thing").val();
          if (thing_id && thing_id !== "0") {
            initProperties(this.connection, thing_id, undefined, outs);
          } else {
            $("select#node-input-property").empty();
          }
          $("#node-input-property").trigger("change");
        });
        $("#node-input-property").change(() => {
          const property_name = $("#node-input-property").find('option:selected').text();
          const property_value = $("#node-input-property").find('option:selected').val();
          if (property_name !== "" && property_value !== "" && property_value !== undefined) {
            this.propname = property_name;
            $("#node-input-name").val(property_name);
          }
          $("#node-input-name").trigger("change");
        });
      },
      oneditsave: function () {
        console.log("thing_id: " + this.thing);
        console.log("property_id: " + this.property);
      }
    });
  }

  setupNode("property in", 0, 1);
  setupNode("property out", 1, 0);
  setupNode("property in hist", 1, 1);//historic
  setupNode("property in poll", 0, 1);//periodic
  setupNode("property in push", 1, 1);//inject
</script>


<script type="text/x-red" data-template-name="property in">
  <div class="form-row node-input-connection">
    <label for="node-input-connection"><i class="fa fa-random"></i> Connection</label>
    <input type="text" id="node-input-connection">
  </div>
  <div class="form-row">
    <label for="node-input-thing"><i class="fa fa-microchip"></i> Thing</label>
    <select id="node-input-thing">
    </select>
  </div>
  <div class="form-row">
      <label for="node-input-property"><i class="fa fa-thermometer-full"></i> Property</label>
      <select id="node-input-property">
      </select>
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
</script>
<script type="text/x-red" data-help-name="property in">
  <p>This node injects in the flow the changed value of a specific Arduino IoT Cloud property.</p>
</script>

<script type="text/x-red" data-template-name="property out">
  <div class="form-row node-input-connection">
    <label for="node-input-connection"><i class="fa fa-random"></i> Connection</label>
    <input type="text" id="node-input-connection">
  </div>
  <div class="form-row">
      <label for="node-input-thing"><i class="fa fa-microchip"></i> Thing</label>
      <select id="node-input-thing">
      </select>
  </div>
  <div class="form-row">
    <label for="node-input-property"><i class="fa fa-thermometer-full"></i> Property</label>
    <select id="node-input-property">
        </select>
  </div>
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
  </div>
</script>
<script type="text/x-red" data-help-name="property out">
  <p>This node update a specific Arduino IoT Cloud property with the value received in input</p>
</script>

<script type="text/javascript">
  function prepareQueryString(connection) {
    const tmpClientid = window.connectionManager[connection] ? window.connectionManager[connection].tmpClientid : "";
    const tmpClientsecret = window.connectionManager[connection] ? window.connectionManager[connection].tmpClientsecret : "";
    if (tmpClientid && tmpClientid !== "" || tmpClientsecret && tmpClientsecret !== "") {
      return `clientid=${tmpClientid}&clientsecret=${tmpClientsecret}`;
    } else if (connection) {
      return `connectionid=${connection}`;
    }
  }
  function initThings(connection, thing_id) {
    const queryString = prepareQueryString(connection);
    if (!queryString || queryString === "")
      return;
    $.getJSON(`things?${queryString}`, things => {
      if (things && typeof (things) == "object" && things.error) {
        $("<option value='" + "" + "'> " + things.error + "</option>").appendTo("#node-input-thing");
      } else if (things && Array.isArray(things) && things.length !== 0) {
        $("<option value='" + "" + "'> " + "Select a thing" + "</option>").appendTo("#node-input-thing");
        for (const t of things) {
          $("<option value='" + t.id + "'>" + t.name + "</option>").appendTo("#node-input-thing");
        }
        if (thing_id !== undefined) {
          $("#node-input-thing").val(thing_id);
          $("#node-input-property").val("");
        }
        $("#node-input-property").trigger("change");
      }
    });
  }
  function initProperties(connection, thing_id, property_id, outs) {
    let queryString = prepareQueryString(connection);
    if (!queryString || queryString === "")
      return;
    if (!thing_id || thing_id === "" || thing_id === "0")
      return;
    queryString = `${queryString}&thing_id=${thing_id}`;
    $("#node-input-property").html("");
    $.getJSON(`properties?${queryString}`, properties => {
      if (properties && typeof (properties) == "object" && properties.error) {
        $("<option value='" + "" + "'> " + things.error + "</option>").appendTo("#node-input-thing");
      } else if ((properties && Array.isArray(properties) && properties.length !== 0)) {
        $("<option value='" + "" + "'> " + "Select a property" + "</option>").appendTo("#node-input-property");
        for (const p of properties) {
          if (outs > 0 || p.permission === "READ_WRITE")
            $("<option value='" + p.id + "'>" + p.name + "</option>").appendTo("#node-input-property");
        }
        if (property_id !== undefined) {
          $("#node-input-property").val(property_id);
        }
        $("#node-input-name").trigger("change");
      }
    });
  }
</script>

<script type="text/javascript">
  RED.nodes.registerType('arduino-connection', {
    category: 'config',
    defaults: {
      applicationname: { value: "", required: true },
    },
    credentials: {
      clientid: { type: "password", required: true },
      clientsecret: { type: "password", required: true }
    },
    label: function () {
      return this.applicationname || "";
    },
    oneditprepare: function () {

    },
    oneditsave: function () {
      if ($("#node-config-input-clientid").val() !== "__PWRD__" || $("#node-config-input-clientsecret").val() !== "__PWRD__") {
        window.connectionManager[this.id] = {
          tmpClientid: $("#node-config-input-clientid").val(),
          tmpClientsecret: $("#node-config-input-clientsecret").val(),
          isUpdatedConnection: true
        }
      } else {
        window.connectionManager[this.id] = {
          tmpClientid: "",
          tmpClientsecret: "",
          isUpdatedConnection: false
        }
      }
    }
  });
</script>
<script type="text/x-red" data-template-name="arduino-connection">
  <div class="form-row">
    <label for="node-config-input-applicationname"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-config-input-applicationname" placeholder="Application name">
  </div>
  <div class="form-row">
    <label for="node-config-input-clientid"><i class="icon-tag"></i> Client ID</label>
    <input type="password" id="node-config-input-clientid" placeholder="Client ID">
  </div>
  <div class="form-row">
    <label for="node-config-input-clientsecret"><i class="icon-tag"></i> Client secret</label>
    <input type="password" id="node-config-input-clientsecret" placeholder="Client secret">
  </div>
</script>
<script type="text/x-red" data-help-name="arduino-connection">
  <p>Provides configuration options for an Arduino IoT Cloud session.</p>
</script>


<script type="text/x-red" data-template-name="property in hist">
  <div class="form-row node-input-connection">
    <label for="node-input-connection"><i class="fa fa-random"></i> Connection</label>
    <input type="text" id="node-input-connection">
  </div>
  <div class="form-row">
    <label for="node-input-thing"><i class="fa fa-microchip"></i> Thing</label>
    <select id="node-input-thing">
    </select>
  </div>
  <div class="form-row">
      <label for="node-input-property"><i class="fa fa-thermometer-full"></i> Property</label>
      <select id="node-input-property">
      </select>
  </div>
  <div class="form-row" id="time-window-show">
    <label for="node-input-timeWindowCount"><i class="fa fa-history"></i> Time filter</label>
    <label for="node-input-timeWindowCount" style="width:auto">last</label>
    <input type="text" id="node-input-timeWindowCount" style="width:50px;">
    <select id="node-input-timeWindowUnit" style="width:80px;">
        <option value="1">seconds</option>
        <option value="60">minutes</option>
        <option value="3600">hours</option>
        <option value="86400">days</option>
        <option value="604800">weeks</option>
    </select>
    <label for="node-input-lastPoints" style="width:auto; margin-left:10px; margin-right:10px;"></label>
    <input type="hidden" id="node-input-lastPoints" style="width:60px;" placeholder="1000">
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
</script>
<script type="text/x-red" data-help-name="property in hist">
  <p>This node injects in the flow a set of values of an Arduino Cloud Property based on the node configuration.</p>
</script>

<script type="text/x-red" data-template-name="property in poll">
  <div class="form-row node-input-connection">
    <label for="node-input-connection"><i class="fa fa-random"></i> Connection</label>
    <input type="text" id="node-input-connection">
  </div>
  <div class="form-row">
    <label for="node-input-thing"><i class="fa fa-microchip"></i> Thing</label>
    <select id="node-input-thing">
    </select>
  </div>
  <div class="form-row">
      <label for="node-input-property"><i class="fa fa-thermometer-full"></i> Property</label>
      <select id="node-input-property">
      </select>
  </div>
  <div class="form-row" id="time-window-show">
    <label for="node-input-timeWindowCount"><i class="fa fa-repeat"></i> Poll Every</label>
    <input type="text" id="node-input-timeWindowCount" style="width:50px;">
    <select id="node-input-timeWindowUnit" style="width:80px;">
        <option value="1">seconds</option>
        <option value="60">minutes</option>
        <option value="3600">hours</option>
        <option value="86400">days</option>
        <option value="604800">weeks</option>
    </select>
    <label for="node-input-lastPoints" style="width:auto; margin-left:10px; margin-right:10px;"></label>
    <input type="hidden" id="node-input-lastPoints" style="width:60px;" placeholder="1000">
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
</script>
<script type="text/x-red" data-help-name="property in poll">
  <p>This node injects in the flow the value of an Arduino Cloud Property with a periodicity based on the node configuration.</p>
</script>


<script type="text/x-red" data-template-name="property in push">
  <div class="form-row node-input-connection">
    <label for="node-input-connection"><i class="fa fa-random"></i> Connection</label>
    <input type="text" id="node-input-connection">
  </div>
  <div class="form-row">
    <label for="node-input-thing"><i class="fa fa-microchip"></i> Thing</label>
    <select id="node-input-thing">
    </select>
  </div>
  <div class="form-row">
      <label for="node-input-property"><i class="fa fa-thermometer-full"></i> Property</label>
      <select id="node-input-property">
      </select>
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
</script>
<script type="text/x-red" data-help-name="property in push">
  <p>This node injects in the flow the value of an Arduino Cloud Property after receiving an input event.</p>
</script>